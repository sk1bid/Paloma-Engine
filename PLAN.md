# Paloma Engine ‚Äî –ü–æ–ª–Ω—ã–π –ü–ª–∞–Ω –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

Metal 4 –¥–≤–∏–∂–æ–∫ —Å EnTT ECS, Frame Graph —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º, MetalFX –∏ ML –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π.

---

## üìö –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ–± –û–±—É—á–µ–Ω–∏–∏

> **–†–æ–ª—å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:** –Ø ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, –∞ —É—á–∏—Ç–µ–ª—å –∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥, –∞ –Ω–∞—É—á–∏—Ç—å —Ç–µ–±—è –ø–æ–Ω–∏–º–∞—Ç—å –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É, –∫–∞–∂–¥—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é.

### –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –æ–±—É—á–µ–Ω–∏—è

#### 1. –¢–µ–æ—Ä–∏—è –ø–µ—Ä–≤–∏—á–Ω–∞
–ü–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –ª—é–±–æ–≥–æ –∫–æ–¥–∞ —è –æ–±—ä—è—Å–Ω—è—é:
- **–ó–∞—á–µ–º** —ç—Ç–æ –Ω—É–∂–Ω–æ (–º–æ—Ç–∏–≤–∞—Ü–∏—è)
- **–ö–∞–∫** —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- **–ü–æ—á–µ–º—É** –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤)

#### 2. –ö–æ–¥ –º–∞–ª—ã–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏
- –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –∫–æ–¥–∞ ‚Äî **–Ω–µ –±–æ–ª–µ–µ 20-30 —Å—Ç—Ä–æ–∫**
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ **–∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏**
- –°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ

#### 3. –õ–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫
1. –°–Ω–∞—á–∞–ª–∞ **–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å** (—á—Ç–æ —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å)
2. –ó–∞—Ç–µ–º **—Å–∏–≥–Ω–∞—Ç—É—Ä—ã** (–∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏/–∫–ª–∞—Å—Å—ã –Ω—É–∂–Ω—ã)
3. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ **—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (–ø–æ—Å—Ç—Ä–æ—á–Ω–æ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏)
4. –í –∫–æ–Ω—Ü–µ **–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è** (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏)

#### 4. –ù–µ –±–µ–∂–∞—Ç—å –≤–ø–µ—Ä–µ–¥–∏ –ø–∞—Ä–æ–≤–æ–∑–∞
- –û–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ —Ä–∞–∑
- –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
- –í–æ–∑–≤—Ä–∞—Ç –∫ —Ç–µ–æ—Ä–∏–∏ –ø—Ä–∏ –ª—é–±—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö

### –§–æ—Ä–º–∞—Ç —É—Ä–æ–∫–∞

```
üìñ –¢–ï–û–†–ò–Ø: [–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏]
   ‚îî‚îÄ‚îÄ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ 3-5 –∞–±–∑–∞—Ü–µ–≤

üîß –ó–ê–î–ê–ß–ê: [–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å]
   ‚îî‚îÄ‚îÄ –û–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞

üíª –ö–û–î: [–§–∞–π–ª.hpp/cpp]
   ‚îî‚îÄ‚îÄ –ú–∞–ª–µ–Ω—å–∫–∏–π –±–ª–æ–∫ (10-20 —Å—Ç—Ä–æ–∫)
   ‚îî‚îÄ‚îÄ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ

‚úÖ –ü–†–û–í–ï–†–ö–ê: [–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏]
   ‚îî‚îÄ‚îÄ –ö–∞–∫ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### –ü—Ä–∞–≤–∏–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

| –ü—Ä–∞–≤–∏–ª–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| **–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã** | –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å –∏ —Å–ø—Ä–æ—Å–∏ |
| **–ù–µ –∫–æ–ø–∏—Ä—É–π —Å–ª–µ–ø–æ** | –ü–∏—à–∏ –∫–æ–¥ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, –ø–æ–Ω–∏–º–∞—è –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É |
| **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π** | –ú–µ–Ω—è–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Å–º–æ—Ç—Ä–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç |
| **–û—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–æ** | –ö–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–Ω—è—Ç—å –≥–ª—É–±–∂–µ |

---

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

### Apple Frameworks
| –§—Ä–µ–π–º–≤–æ—Ä–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|
| **Metal** | GPU API (—á–µ—Ä–µ–∑ metal-cpp) |
| **MetalKit** | MTKView, –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä/–º–µ—à–µ–π |
| **ModelIO** | –ó–∞–≥—Ä—É–∑–∫–∞ 3D –º–æ–¥–µ–ª–µ–π |
| **MetalFX** | –ê–ø—Å–∫–µ–π–ª–∏–Ω–≥, –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–∞–¥—Ä–æ–≤ |
| **AppKit** | –û–∫–Ω–∞, —Å–æ–±—ã—Ç–∏—è |
| **simd** | –í–µ–∫—Ç–æ—Ä–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ |

### –í–Ω–µ—à–Ω–∏–µ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏
| –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| **metal-cpp** | latest | C++ –±–∏–Ω–¥–∏–Ω–≥–∏ –¥–ª—è Metal 4 |
| **EnTT** | 3.13+ | Entity-Component-System |

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞

```
PalomaEngine/
‚îú‚îÄ‚îÄ Source/
‚îÇ   ‚îú‚îÄ‚îÄ Core/           # –Ø–¥—Ä–æ Metal 4
‚îÇ   ‚îú‚îÄ‚îÄ Renderer/       # Frame Graph, –ø–∞—Å—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ Scene/          # EnTT ECS, –∫–∞–º–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ Assets/         # –ú–µ—à–∏, –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ Input/          # –í–≤–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ Platform/       # Obj-C++ –º–æ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ Shaders/        # Metal —à–µ–π–¥–µ—Ä—ã
‚îú‚îÄ‚îÄ Demos/              # –î–µ–º–æ-—Å—Ü–µ–Ω—ã
‚îú‚îÄ‚îÄ App/                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ Libs/
‚îÇ   ‚îú‚îÄ‚îÄ metal-cpp/
‚îÇ   ‚îî‚îÄ‚îÄ entt/
‚îî‚îÄ‚îÄ Resources/          # –ê—Å—Å–µ—Ç—ã
```

---

## –ù–µ–¥–µ–ª—è 1: –Ø–¥—Ä–æ Metal 4

### –¶–µ–ª—å: –ö—É–± –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å Metal 4 API

---

#### [–ù–û–í–´–ô] [Types.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Core/Types.hpp)
–ë–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã –∏ SIMD –∞–ª–∏–∞—Å—ã.
```cpp
namespace Paloma {
    using float2 = simd::float2;
    using float3 = simd::float3;
    using float4 = simd::float4;
    using float4x4 = simd::float4x4;
    using quatf = simd::quatf;
    
    constexpr uint32_t MaxFramesInFlight = 3;
}
```

---

#### [–ù–û–í–´–ô] [Context.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Core/Context.hpp)
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π Metal 4 –∫–æ–Ω—Ç–µ–∫—Å—Ç.
```cpp
class Context {
    MTL::Device*              _device;
    MTL4::CommandQueue*       _commandQueue;
    MTL4::CommandAllocator*   _allocators[3];
    MTL4::CommandBuffer*      _commandBuffer;
    MTL4::Compiler*           _compiler;
    MTL4::ArgumentTable*      _argumentTable;
    MTL::ResidencySet*        _residencySet;
    MTL::SharedEvent*         _frameEvent;
    
public:
    void init();
    void shutdown();
    void beginFrame();
    void endFrame(CA::MetalDrawable* drawable);
    
    // –ì–µ—Ç—Ç–µ—Ä—ã
    MTL::Device* device();
    MTL4::CommandBuffer* commandBuffer();
    MTL4::Compiler* compiler();
    MTL4::ArgumentTable* argumentTable();
};
```

---

#### [–ù–û–í–´–ô] [Context.cpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Core/Context.cpp)
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
1. `init()` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ device, queue, allocators, compiler, residency set
2. `beginFrame()` ‚Äî –æ–∂–∏–¥–∞–Ω–∏–µ –∫–∞–¥—Ä–∞ N-3, —Å–±—Ä–æ—Å –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞, –Ω–∞—á–∞–ª–æ command buffer
3. `endFrame()` ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ buffer, commit, signal event, present

---

#### [–ù–û–í–´–ô] [Bridge.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Platform/Bridge.hpp)
C++ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ Objective-C API.
```cpp
namespace Bridge {
    MTL4::RenderPassDescriptor* currentRenderPassDescriptor(void* view);
    CA::MetalDrawable* currentDrawable(void* view);
    MTL::ResidencySet* layerResidencySet(void* view);
    void waitForEvent(MTL::SharedEvent* event, uint64_t value, uint64_t timeout);
    CGSize viewSize(void* view);
}
```

---

#### [–ù–û–í–´–ô] [Bridge.mm](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Platform/Bridge.mm)
Obj-C++ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å `(__bridge ...)` –∫–∞—Å—Ç–∞–º–∏.

---

#### [–ù–û–í–´–ô] [main.mm](file:///Users/sk1bid/Desktop/Paloma%20Engine/App/main.mm)
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

#### [–ù–û–í–´–ô] [AppDelegate.mm](file:///Users/sk1bid/Desktop/Paloma%20Engine/App/AppDelegate.mm)
–î–µ–ª–µ–≥–∞—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞.

#### [–ù–û–í–´–ô] [MTKViewDelegate.mm](file:///Users/sk1bid/Desktop/Paloma%20Engine/App/MTKViewDelegate.mm)
Callback `drawInMTKView:` ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç Engine::render().

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 1
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `Types.hpp` | ~30 | –¢–∏–ø—ã |
| `Context.hpp/cpp` | ~200 | Metal 4 —è–¥—Ä–æ |
| `Bridge.hpp/mm` | ~80 | Obj-C++ –º–æ—Å—Ç |
| `main.mm` | ~50 | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ |
| `AppDelegate.mm` | ~40 | –î–µ–ª–µ–≥–∞—Ç |
| `MTKViewDelegate.mm` | ~50 | Render loop |

---

## –ù–µ–¥–µ–ª—è 2: –†–µ—Å—É—Ä—Å—ã –∏ –ë–∏–Ω–¥–∏–Ω–≥

### –¶–µ–ª—å: –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏

---

#### [–ù–û–í–´–ô] [Mesh.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Assets/Mesh.hpp)
```cpp
struct Submesh {
    uint32_t indexStart;
    uint32_t indexCount;
    MTL::IndexType indexType;
};

class Mesh {
    MTL::Buffer* _vertexBuffer;
    MTL::Buffer* _indexBuffer;
    std::vector<Submesh> _submeshes;
public:
    MTL::GPUAddress vertexAddress() const;
    MTL::GPUAddress indexAddress() const;
};
```

---

#### [–ù–û–í–´–ô] [MeshLoader.mm](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Platform/MeshLoader.mm)
–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `MDLMesh` + `MTKMesh`.

---

#### [–ù–û–í–´–ô] [TextureLoader.mm](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Platform/TextureLoader.mm)
–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `MTKTextureLoader`.

---

#### [–ù–û–í–´–ô] [AssetManager.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Assets/AssetManager.hpp)
```cpp
class AssetManager {
    std::unordered_map<std::string, Mesh*> _meshes;
    std::unordered_map<std::string, MTL::Texture*> _textures;
public:
    Mesh* getMesh(const char* name);
    MTL::Texture* getTexture(const char* name);
    void registerWithResidencySet(MTL::ResidencySet* set);
};
```

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 2
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `Mesh.hpp` | ~50 | –î–∞–Ω–Ω—ã–µ –º–µ—à–∞ |
| `MeshLoader.mm` | ~100 | ModelIO –º–æ—Å—Ç |
| `TextureLoader.mm` | ~60 | –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä |
| `AssetManager.hpp/cpp` | ~120 | –ö–µ—à —Ä–µ—Å—É—Ä—Å–æ–≤ |

---

## –ù–µ–¥–µ–ª—è 3: –ü–∞–π–ø–ª–∞–π–Ω—ã –∏ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã

### –¶–µ–ª—å: PBR –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏

---

#### [–ù–û–í–´–ô] [Material.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Assets/Material.hpp)
```cpp
struct Material {
    std::string name;
    MTL::RenderPipelineState* pipeline;
    
    // –¢–µ–∫—Å—Ç—É—Ä—ã (ResourceID –¥–ª—è ArgumentTable)
    MTL::ResourceID albedoMap;
    MTL::ResourceID normalMap;
    MTL::ResourceID metallicRoughnessMap;
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    float4 albedoColor = {1,1,1,1};
    float metallic = 0.0f;
    float roughness = 0.5f;
};
```

---

#### [–ù–û–í–´–ô] [PipelineCache.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Renderer/PipelineCache.hpp)
```cpp
class PipelineCache {
    std::unordered_map<size_t, MTL::RenderPipelineState*> _cache;
public:
    MTL::RenderPipelineState* getPipeline(const PipelineDesc& desc);
    MTL::RenderPipelineState* specialize(MTL::RenderPipelineState* base, 
                                         const BlendDesc& blend);
};
```

---

#### [–ù–û–í–´–ô] [ShaderTypes.h](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Shaders/ShaderTypes.h)
–û–±—â–∏–µ —Ç–∏–ø—ã –¥–ª—è C++ –∏ Metal.
```cpp
struct FrameUniforms {
    float4x4 viewMatrix;
    float4x4 projectionMatrix;
    float3   cameraPosition;
    float    time;
};

struct InstanceData {
    float4x4 modelMatrix;
    float4x4 normalMatrix;
};

enum BufferIndex {
    BufferIndexFrameUniforms = 0,
    BufferIndexInstanceData  = 1,
    BufferIndexVertices      = 2,
};
```

---

#### [–ù–û–í–´–ô] [PBR.metal](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Shaders/PBR.metal)
PBR —à–µ–π–¥–µ—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ArgumentTable.

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 3
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `Material.hpp` | ~50 | –ú–∞—Ç–µ—Ä–∏–∞–ª |
| `PipelineCache.hpp/cpp` | ~150 | –ö–µ—à –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ |
| `ShaderTypes.h` | ~60 | –û–±—â–∏–µ —Ç–∏–ø—ã |
| `PBR.metal` | ~200 | –®–µ–π–¥–µ—Ä—ã |

---

## –ù–µ–¥–µ–ª—è 4: Frame Graph

### –¶–µ–ª—å: –ú–Ω–æ–≥–æ–ø—Ä–æ—Ö–æ–¥–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –±–∞—Ä—å–µ—Ä–∞–º–∏

---

#### [–ù–û–í–´–ô] [FrameGraph.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Renderer/FrameGraph.hpp)
```cpp
struct ResourceHandle { uint32_t id; };

class FrameGraph {
    struct PassNode {
        std::string name;
        std::vector<ResourceHandle> reads;
        std::vector<ResourceHandle> writes;
        std::function<void(PassContext&)> execute;
    };
    
    std::vector<PassNode> _passes;
    
public:
    ResourceHandle createTexture(const char* name, TextureDesc desc);
    ResourceHandle importBackbuffer(MTL::Texture* tex);
    
    template<typename T>
    void addPass(const char* name, 
                 std::function<void(T&, Builder&)> setup,
                 std::function<void(const T&, PassContext&)> exec);
    
    void compile();   // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    void execute(Context& ctx);  // –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–∞—Å—Å—ã
};
```

---

#### [–ù–û–í–´–ô] [BuiltinPasses.cpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Renderer/Passes/BuiltinPasses.cpp)
```cpp
void addOpaquePass(FrameGraph& fg, entt::registry& reg, Camera& cam);
void addShadowPass(FrameGraph& fg, entt::registry& reg, Light& light);
void addBloomPass(FrameGraph& fg, ResourceHandle hdr);
void addToneMappingPass(FrameGraph& fg, ResourceHandle hdr, ResourceHandle out);
```

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 4
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `FrameGraph.hpp/cpp` | ~300 | Frame Graph |
| `PassContext.hpp` | ~50 | –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞—Å—Å–∞ |
| `BuiltinPasses.cpp` | ~200 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Å—Å—ã |

---

## –ù–µ–¥–µ–ª—è 5: EnTT ECS

### –¶–µ–ª—å: –ò–µ—Ä–∞—Ä—Ö–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π —Å EnTT

---

#### [–ù–û–í–´–ô] [Components.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Scene/Components.hpp)
```cpp
// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è EnTT registry

struct TransformComponent {
    float3 position = {0,0,0};
    quatf rotation = simd_quaternion(0,0,0,1);
    float3 scale = {1,1,1};
    float4x4 worldMatrix;
    entt::entity parent = entt::null;
};

struct MeshComponent {
    Mesh* mesh;
    uint32_t submeshIndex = 0;
};

struct MaterialComponent {
    Material* material;
};

struct LightComponent {
    enum Type { Directional, Point, Spot } type;
    float3 color = {1,1,1};
    float intensity = 1.0f;
    float range = 10.0f;
};

struct CameraComponent {
    float fov = 60.0f;
    float near = 0.1f;
    float far = 1000.0f;
};

struct ChildrenComponent {
    std::vector<entt::entity> children;
};
```

---

#### [–ù–û–í–´–ô] [Scene.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Scene/Scene.hpp)
```cpp
class Scene {
    entt::registry _registry;
    entt::entity _activeCamera = entt::null;
    
public:
    entt::registry& registry() { return _registry; }
    
    entt::entity createEntity();
    void destroyEntity(entt::entity e);
    void setParent(entt::entity child, entt::entity parent);
    
    entt::entity activeCamera();
    void setActiveCamera(entt::entity cam);
};
```

---

#### [–ù–û–í–´–ô] [Systems.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Scene/Systems.hpp)
```cpp
class TransformSystem {
public:
    void update(entt::registry& reg);
private:
    void updateRecursive(entt::registry& reg, entt::entity e, float4x4 parentWorld);
};

class RenderSystem {
public:
    struct DrawCall {
        Mesh* mesh;
        Material* material;
        std::vector<float4x4> instances;
    };
    std::vector<DrawCall> extractDrawCalls(entt::registry& reg, Camera& cam);
};
```

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 5
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `Components.hpp` | ~100 | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã |
| `Scene.hpp/cpp` | ~150 | EnTT –≤—Ä–∞–ø–ø–µ—Ä |
| `Systems.hpp/cpp` | ~150 | –°–∏—Å—Ç–µ–º—ã |

---

## –ù–µ–¥–µ–ª—è 6: –ö–∞–º–µ—Ä–∞ –∏ –í–≤–æ–¥

### –¶–µ–ª—å: WASD + –º—ã—à—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

---

#### [–ù–û–í–´–ô] [Camera.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Scene/Camera.hpp)
```cpp
class Camera {
public:
    float3 position = {0, 0, 5};
    float3 target = {0, 0, 0};
    float3 up = {0, 1, 0};
    
    float fov = 60.0f;
    float aspect = 16.0f / 9.0f;
    float near = 0.1f;
    float far = 1000.0f;
    
    float4x4 viewMatrix() const;
    float4x4 projectionMatrix() const;
    float3 forward() const;
    float3 right() const;
};
```

---

#### [–ù–û–í–´–ô] [Input.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Input/Input.hpp)
```cpp
class Input {
    bool _keys[256] = {};
    bool _keysPressed[256] = {};
    float2 _mousePosition = {0, 0};
    float2 _mouseDelta = {0, 0};
    bool _mouseButtons[3] = {};
    
public:
    bool isKeyDown(uint8_t key) const;
    bool isKeyPressed(uint8_t key) const;
    float2 mouseDelta() const;
    bool isMouseDown(int button) const;
};
```

---

#### [–ù–û–í–´–ô] [CameraControllers.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Scene/Controllers/CameraControllers.hpp)
```cpp
// –û—Ä–±–∏—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ (–∫–ª–∏–∫-–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ)
class OrbitController {
    float _distance = 5.0f;
    float _yaw = 0.0f, _pitch = 0.0f;
public:
    void update(const Input& input, Camera& cam);
};

// FPS —Å—Ç–∏–ª—å (WASD + –º—ã—à—å)
class FlyController {
    float _yaw = 0.0f, _pitch = 0.0f;
    float _moveSpeed = 5.0f;
public:
    void update(const Input& input, Camera& cam, float dt);
};

// –°–ø–ª–∞–π–Ω–æ–≤–∞—è –∫–∞–º–µ—Ä–∞ (–¥–ª—è —Å–∏–Ω–µ–º–∞—Ç–∏–∫–æ–≤)
class PathController {
    struct Key { float time; float3 position; float3 target; };
    std::vector<Key> _keys;
    float _time = 0.0f;
public:
    void addKey(float t, float3 pos, float3 target);
    void update(Camera& cam, float dt);
    bool isFinished() const;
};
```

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 6
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `Camera.hpp/cpp` | ~100 | –ö–∞–º–µ—Ä–∞ |
| `Input.hpp/cpp` | ~100 | –í–≤–æ–¥ |
| `CameraControllers.hpp/cpp` | ~200 | –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã |

---

## –ù–µ–¥–µ–ª—è 7: MetalFX –∏ ML

### –¶–µ–ª—å: –ê–ø—Å–∫–µ–π–ª–∏–Ω–≥, –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è, –Ω–µ–π—Ä–æ—Å–µ—Ç–∏

---

#### [–ù–û–í–´–ô] [MetalFXManager.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Renderer/MetalFXManager.hpp)
```cpp
class MetalFXManager {
    MTLFXTemporalScaler* _upscaler;
    MTLFXFrameInterpolator* _interpolator;
public:
    void init(MTL::Device* device, uint32_t renderW, uint32_t renderH,
              uint32_t outputW, uint32_t outputH);
    
    void upscale(MTL::Texture* color, MTL::Texture* depth, 
                 MTL::Texture* motion, MTL::Texture* output);
    
    void interpolate(MTL::Texture* prev, MTL::Texture* curr, MTL::Texture* out);
};
```

---

#### [–ù–û–í–´–ô] [MLPassManager.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Source/Renderer/MLPassManager.hpp)
```cpp
class MLPassManager {
    MTL4::MachineLearningPipelineState* _denoisePipeline;
public:
    void loadModel(MTL4::Compiler* compiler, const char* modelPath);
    void denoise(MTL4::CommandBuffer* cmd, MTL::Texture* noisy, MTL::Texture* out);
};
```

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 7
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `MetalFXManager.hpp/cpp` | ~150 | –ê–ø—Å–∫–µ–π–ª–∏–Ω–≥ |
| `MLPassManager.hpp/cpp` | ~100 | –ù–µ–π—Ä–æ—Å–µ—Ç–∏ |

---

## –ù–µ–¥–µ–ª—è 8: –î–µ–º–æ-—Å—Ü–µ–Ω—ã

### –¶–µ–ª—å: –¢—Ä–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –¥–µ–º–∫–∏

---

#### [–ù–û–í–´–ô] [CornellBoxScene.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Demos/CornellBoxScene.hpp)
**Cornell Box (PBR Edition)**
- –ö–æ–º–Ω–∞—Ç–∞ —Å —Ü–≤–µ—Ç–Ω—ã–º–∏ —Å—Ç–µ–Ω–∞–º–∏ (–∫—Ä–∞—Å–Ω–∞—è/–∑–µ–ª—ë–Ω–∞—è)
- –î–≤–∞ –±–æ–∫—Å–∞
- Area light —Å–≤–µ—Ä—Ö—É
- PBR –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- **–¢–µ—Å—Ç–∏—Ä—É–µ—Ç:** Renderer, Materials, Lighting

---

#### [–ù–û–í–´–ô] [InstancedForestScene.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Demos/InstancedForestScene.hpp)
**Instanced Forest (10k –¥–µ—Ä–µ–≤—å–µ–≤)**
- 10,000 –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –¥–µ—Ä–µ–≤—å–µ–≤
- GPU –∏–Ω—Å—Ç–∞–Ω—Å–∏–Ω–≥
- Compute —à–µ–π–¥–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–µ—Ç—Ä–∞
- Fly –∫–∞–º–µ—Ä–∞
- **–¢–µ—Å—Ç–∏—Ä—É–µ—Ç:** ECS –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, Compute

---

#### [–ù–û–í–´–ô] [NeonCityScene.hpp](file:///Users/sk1bid/Desktop/Paloma%20Engine/Demos/NeonCityScene.hpp)
**Neon Fly-through**
- –ì–æ—Ä–æ–¥ —Å –Ω–µ–æ–Ω–æ–≤—ã–º–∏ –æ–≥–Ω—è–º–∏
- Path –∫–∞–º–µ—Ä–∞ (–ø—Ä–æ–ª—ë—Ç)
- HDR + Bloom
- MetalFX –∞–ø—Å–∫–µ–π–ª–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–¢–µ—Å—Ç–∏—Ä—É–µ—Ç:** Frame Graph, Post-FX, PathController

---

### –§–∞–π–ª—ã –ù–µ–¥–µ–ª–∏ 8
| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|------------|
| `CornellBoxScene.hpp/cpp` | ~150 | –î–µ–º–æ PBR |
| `InstancedForestScene.hpp/cpp` | ~200 | –î–µ–º–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
| `NeonCityScene.hpp/cpp` | ~250 | –î–µ–º–æ FX |
| `DemoSelector.hpp/cpp` | ~50 | –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å—Ü–µ–Ω |

---

## –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### –ö–æ–º–∞–Ω–¥—ã –°–±–æ—Ä–∫–∏
```bash
# –°–±–æ—Ä–∫–∞
xcodebuild -project "PalomaEngine.xcodeproj" -scheme "PalomaEngine" build

# –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–∫
./build/PalomaEngine --demo cornell
./build/PalomaEngine --demo forest
./build/PalomaEngine --demo neon
```

### –¶–µ–ª–µ–≤—ã–µ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏
| –î–µ–º–∫–∞ | FPS | GPU Time |
|-------|-----|----------|
| Cornell Box | 60+ | < 4ms |
| Forest (10k) | 60+ | < 8ms |
| Neon City | 60+ | < 12ms |

---

## –ü–æ–ª–Ω—ã–π –°–ø–∏—Å–æ–∫ –§–∞–π–ª–æ–≤

| –ù–µ–¥–µ–ª—è | –§–∞–π–ª—ã |
|--------|-------|
| **1** | `Types.hpp`, `Context.hpp/cpp`, `Bridge.hpp/mm`, `main.mm`, `AppDelegate.mm`, `MTKViewDelegate.mm` |
| **2** | `Mesh.hpp`, `MeshLoader.mm`, `TextureLoader.mm`, `AssetManager.hpp/cpp` |
| **3** | `Material.hpp`, `PipelineCache.hpp/cpp`, `ShaderTypes.h`, `PBR.metal` |
| **4** | `FrameGraph.hpp/cpp`, `PassContext.hpp`, `BuiltinPasses.cpp` |
| **5** | `Components.hpp`, `Scene.hpp/cpp`, `Systems.hpp/cpp` |
| **6** | `Camera.hpp/cpp`, `Input.hpp/cpp`, `CameraControllers.hpp/cpp` |
| **7** | `MetalFXManager.hpp/cpp`, `MLPassManager.hpp/cpp` |
| **8** | `CornellBoxScene.hpp/cpp`, `InstancedForestScene.hpp/cpp`, `NeonCityScene.hpp/cpp`, `DemoSelector.hpp/cpp` |

**–í—Å–µ–≥–æ:** ~45 —Ñ–∞–π–ª–æ–≤, ~3500 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
